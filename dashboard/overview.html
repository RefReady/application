<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Club Dashboard - RefReady</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="dashboard.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèê</text></svg>">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="dashboard-logo">
                <span class="logo-icon">üèê</span>
                <span class="logo-text">RefReady</span>
                <span class="dashboard-subtitle">Club Dashboard</span>
            </div>
            <div class="dashboard-user">
                <div class="user-info">
                    <div class="user-name" id="club-name">Loading...</div>
                    <div class="user-role" id="club-role">Club Administrator</div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </header>

        <div class="dashboard-main">
            <!-- Sidebar -->
            <nav class="dashboard-sidebar">
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="overview.html" class="nav-link active">
                            <span class="nav-icon">üìä</span>
                            <span>Overview</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="referees.html" class="nav-link">
                            <span class="nav-icon">üë•</span>
                            <span>Referees</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="mentors.html" class="nav-link">
                            <span class="nav-icon">ü§ù</span>
                            <span>Mentors</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="safety.html" class="nav-link">
                            <span class="nav-icon">üÜò</span>
                            <span>Safety Alerts</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="reports.html" class="nav-link">
                            <span class="nav-icon">üìã</span>
                            <span>Reports</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="settings.html" class="nav-link">
                            <span class="nav-icon">‚öôÔ∏è</span>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- Main Content -->
            <main class="dashboard-content">
                <!-- Demo Banner -->
                <div id="demo-banner" class="demo-banner" style="display: none;">
                    <div class="banner-content">
                        <span class="banner-icon">üéØ</span>
                        <div class="banner-text">
                            <strong>Demo Mode</strong>
                            <span>You're viewing sample data. Start your free trial to manage real referees.</span>
                        </div>
                        <button class="btn btn-primary btn-sm">Start Free Trial</button>
                    </div>
                </div>

                <!-- Page Title -->
                <div class="page-header">
                    <h1 class="page-title">Dashboard Overview</h1>
                    <p class="page-subtitle">Monitor your club's referee development and activity</p>
                </div>

                <!-- Key Metrics -->
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-icon">üë•</div>
                        <div class="metric-content">
                            <div class="metric-number" id="total-referees">0</div>
                            <div class="metric-label">Active Referees</div>
                            <div class="metric-change">Getting started</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">ü§ù</div>
                        <div class="metric-content">
                            <div class="metric-number" id="total-mentors">0</div>
                            <div class="metric-label">Active Mentors</div>
                            <div class="metric-change">Getting started</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üèê</div>
                        <div class="metric-content">
                            <div class="metric-number" id="weekly-games">0</div>
                            <div class="metric-label">Games This Week</div>
                            <div class="metric-change">Getting started</div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üìà</div>
                        <div class="metric-content">
                            <div class="metric-number" id="avg-confidence">-</div>
                            <div class="metric-label">Avg Confidence</div>
                            <div class="metric-change">No data yet</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <h2 class="section-title">Quick Actions</h2>
                    <div class="actions-grid">
                        <div class="action-card" onclick="showInviteReferee()">
                            <div class="action-icon">üìß</div>
                            <div class="action-content">
                                <h3>Invite Referee</h3>
                                <p>Add a new referee to your club</p>
                            </div>
                        </div>
                        <div class="action-card" onclick="showInviteMentor()">
                            <div class="action-icon">ü§ù</div>
                            <div class="action-content">
                                <h3>Invite Mentor</h3>
                                <p>Add a new mentor to support referees</p>
                            </div>
                        </div>
                        <div class="action-card" onclick="showAssignMentor()">
                            <div class="action-icon">üéØ</div>
                            <div class="action-content">
                                <h3>Assign Mentor</h3>
                                <p>Match mentors with referees</p>
                            </div>
                        </div>
                        <div class="action-card" onclick="generateReport()">
                            <div class="action-icon">üìä</div>
                            <div class="action-content">
                                <h3>Generate Report</h3>
                                <p>Download club progress reports</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="recent-activity">
                    <h2 class="section-title">Recent Activity</h2>
                    <div class="activity-list" id="activity-list">
                        <div class="activity-item" style="text-align: center; padding: 40px; color: #666;">
                            <div style="font-size: 2em; margin-bottom: 10px;">üìä</div>
                            <h3>No Recent Activity</h3>
                            <p>Activity will appear here as your referees start using the platform.</p>
                        </div>
                    </div>
                </div>

                <!-- Top Performers -->
                <div class="top-performers">
                    <h2 class="section-title">Top Performers This Month</h2>
                    <div class="performers-grid" id="performers-grid">
                        <div style="text-align: center; padding: 40px; color: #666; grid-column: 1 / -1;">
                            <div style="font-size: 2em; margin-bottom: 10px;">üèÜ</div>
                            <h3>No Performance Data Yet</h3>
                            <p>Top performers will be displayed here once your referees start logging games.</p>
                        </div>
                    </div>
                </div>

                <!-- Safety Status -->
                <div class="safety-status">
                    <h2 class="section-title">Safety Status</h2>
                    <div class="safety-card">
                        <div class="safety-icon">‚úÖ</div>
                        <div class="safety-content">
                            <h3>All Clear</h3>
                            <p>No active safety incidents reported</p>
                            <div class="safety-stats">
                                <span>2 incidents resolved this month</span>
                                <span>0 pending follow-ups</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Invite Referee Modal -->
    <div id="invite-referee-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('invite-referee-modal')">&times;</span>
            <h2>Invite New Referee</h2>
            <p class="modal-subtitle">Send an invitation to join your club with multiple easy joining options</p>
            
            <form id="invite-referee-form">
                <div class="form-group">
                    <label for="referee-name">Referee Name</label>
                    <input type="text" id="referee-name" required placeholder="Enter referee's full name">
                </div>
                <div class="form-group">
                    <label for="referee-email">Email Address</label>
                    <input type="email" id="referee-email" required placeholder="referee@example.com">
                </div>
                <div class="form-group">
                    <label for="referee-phone">Phone Number (Optional)</label>
                    <input type="tel" id="referee-phone" placeholder="0412 345 678">
                </div>
                <div class="form-group">
                    <label for="referee-level">Experience Level</label>
                    <select id="referee-level" required>
                        <option value="">Select level...</option>
                        <option value="newcomer">Newcomer (0-6 months)</option>
                        <option value="developing">Developing (6-18 months)</option>
                        <option value="experienced">Experienced (18+ months)</option>
                        <option value="senior">Senior (3+ years)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="invitation-method">Invitation Method</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="invitation-method" value="email" checked>
                            <span class="radio-label">üìß Email with Direct Link & QR Code</span>
                            <small>Recommended: One-click join + QR code for mobile</small>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="invitation-method" value="code">
                            <span class="radio-label">üîë Club Code Only</span>
                            <small>Generate code for referee to enter manually</small>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="invitation-method" value="qr">
                            <span class="radio-label">üì± QR Code Only</span>
                            <small>Generate QR code for in-person recruitment</small>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="personal-message">Personal Message (Optional)</label>
                    <textarea id="personal-message" rows="3" placeholder="Add a personal welcome message..."></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('invite-referee-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="button-text">Send Invitation</span>
                        <span class="button-loading" style="display: none;">Sending...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invitation Success Modal -->
    <div id="invitation-success-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('invitation-success-modal')">&times;</span>
            <div class="success-content">
                <div class="success-icon">‚úÖ</div>
                <h2>Invitation Sent Successfully!</h2>
                <p id="success-message">Invitation details will appear here</p>
                
                <div id="invitation-details" style="display: none;">
                    <div class="invitation-info">
                        <h3>Invitation Details</h3>
                        <div class="info-item">
                            <strong>Club Code:</strong> <span id="generated-club-code"></span>
                            <button class="btn btn-sm btn-outline" onclick="copyToClipboard('generated-club-code')">Copy</button>
                        </div>
                        <div class="info-item">
                            <strong>Invitation Link:</strong> 
                            <div class="link-container">
                                <input type="text" id="invitation-link" readonly>
                                <button class="btn btn-sm btn-outline" onclick="copyToClipboard('invitation-link')">Copy</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="qr-code-container" style="display: none;">
                        <h3>QR Code for Mobile Scanning</h3>
                        <div id="qr-code-display"></div>
                        <p class="qr-instructions">Referee can scan this QR code with their mobile app to join instantly</p>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-outline" onclick="downloadInvitation()">Download Details</button>
                    <button class="btn btn-primary" onclick="closeModal('invitation-success-modal')">Done</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Invite Mentor Modal -->
    <div id="invite-mentor-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('invite-mentor-modal')">&times;</span>
            <h2>Invite New Mentor</h2>
            <form id="invite-mentor-form">
                <div class="form-group">
                    <label for="mentor-name">Mentor Name</label>
                    <input type="text" id="mentor-name" required placeholder="Enter mentor's full name">
                </div>
                <div class="form-group">
                    <label for="mentor-email">Email Address</label>
                    <input type="email" id="mentor-email" required placeholder="mentor@example.com">
                </div>
                <div class="form-group">
                    <label for="mentor-experience">Years of Experience</label>
                    <input type="number" id="mentor-experience" min="1" max="50" required placeholder="5">
                </div>
                <div class="form-group">
                    <label for="mentor-specialties">Specialties</label>
                    <input type="text" id="mentor-specialties" placeholder="e.g., Confidence Building, Rule Knowledge">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="closeModal('invite-mentor-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Invitation</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { DashboardManager } from './dashboard.js';
        
        // Initialize dashboard with real Firebase data
        const dashboardManager = new DashboardManager();
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await dashboardManager.init();
                console.log('Dashboard loaded with real club data');
            } catch (error) {
                console.error('Dashboard initialization failed:', error);
                window.location.href = 'login.html';
            }
        });
        
        // Global functions for onclick events
        function logout() {
            dashboardManager.logout();
        }
        
        function showInviteReferee() {
            document.getElementById('invite-referee-modal').style.display = 'block';
        }
        
        function showInviteMentor() {
            document.getElementById('invite-mentor-modal').style.display = 'block';
        }
        
        function showAssignMentor() {
            dashboardManager.showNotification('Mentor assignment feature coming soon!', 'info');
        }
        
        function generateReport() {
            dashboardManager.showNotification('Report generation feature coming soon!', 'info');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
        
        // Handle form submissions
        document.getElementById('invite-referee-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await handleInviteReferee();
        });

        // Handle invite referee submission
        async function handleInviteReferee() {
            const form = document.getElementById('invite-referee-form');
            const submitBtn = form.querySelector('button[type="submit"]');
            const formData = new FormData(form);
            
            // Show loading state
            submitBtn.classList.add('loading');
            
            try {
                // Get form values
                const inviteData = {
                    name: formData.get('referee-name') || document.getElementById('referee-name').value,
                    email: formData.get('referee-email') || document.getElementById('referee-email').value,
                    phone: formData.get('referee-phone') || document.getElementById('referee-phone').value,
                    level: formData.get('referee-level') || document.getElementById('referee-level').value,
                    method: formData.get('invitation-method') || document.querySelector('input[name="invitation-method"]:checked').value,
                    personalMessage: formData.get('personal-message') || document.getElementById('personal-message').value
                };
                
                // Generate invitation
                const invitationResult = await createRefereeInvitation(inviteData);
                
                if (invitationResult.success) {
                    // Close invite modal
                    closeModal('invite-referee-modal');
                    
                    // Show success modal
                    showInvitationSuccess(invitationResult);
                    
                    // Reset form
                    form.reset();
                    
                    dashboardManager.showNotification('Invitation sent successfully!', 'success');
                } else {
                    throw new Error(invitationResult.error || 'Failed to send invitation');
                }
                
            } catch (error) {
                console.error('Invitation error:', error);
                dashboardManager.showNotification('Failed to send invitation: ' + error.message, 'error');
            } finally {
                // Hide loading state
                submitBtn.classList.remove('loading');
            }
        }

        // Create referee invitation
        async function createRefereeInvitation(inviteData) {
            try {
                // Generate unique invitation ID and club code
                const invitationId = generateInvitationId();
                const clubCode = generateClubCode();
                
                // Get current user and club info
                const currentUser = dashboardManager.getCurrentUser();
                const clubInfo = await getClubInfo(currentUser.uid);
                
                // Create invitation data
                const invitation = {
                    id: invitationId,
                    clubId: currentUser.uid,
                    clubName: clubInfo.name,
                    clubCode: clubCode,
                    refereeName: inviteData.name,
                    refereeEmail: inviteData.email,
                    refereePhone: inviteData.phone,
                    refereeLevel: inviteData.level,
                    personalMessage: inviteData.personalMessage,
                    method: inviteData.method,
                    status: 'pending',
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString() // 7 days
                };
                
                // Save invitation to database
                await saveInvitation(invitation);
                
                // Generate invitation link
                const invitationLink = generateInvitationLink(invitationId, clubCode);
                
                // Send invitation based on method
                if (inviteData.method === 'email') {
                    await sendInvitationEmail(invitation, invitationLink);
                }
                
                return {
                    success: true,
                    invitation: invitation,
                    invitationLink: invitationLink,
                    qrCodeData: invitationLink
                };
                
            } catch (error) {
                console.error('Create invitation error:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }

        // Generate unique invitation ID
        function generateInvitationId() {
            return 'inv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Generate club code
        function generateClubCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Generate invitation link
        function generateInvitationLink(invitationId, clubCode) {
            const baseUrl = window.location.origin;
            return `${baseUrl}/mobile/join?invitation=${invitationId}&club=${clubCode}`;
        }

        // Get club info
        async function getClubInfo(clubId) {
            try {
                const clubDoc = await dbFunctions.getDoc(dbFunctions.doc(dbFunctions.db, 'clubs', clubId));
                if (clubDoc.exists()) {
                    return clubDoc.data();
                } else {
                    return {
                        name: 'RefReady Club',
                        email: dashboardManager.getCurrentUser().email
                    };
                }
            } catch (error) {
                console.error('Get club info error:', error);
                return {
                    name: 'RefReady Club',
                    email: dashboardManager.getCurrentUser().email
                };
            }
        }

        // Save invitation to database
        async function saveInvitation(invitation) {
            try {
                await dbFunctions.setDoc(
                    dbFunctions.doc(dbFunctions.db, 'invitations', invitation.id),
                    invitation
                );
            } catch (error) {
                console.error('Save invitation error:', error);
                throw error;
            }
        }

        // Send invitation email
        async function sendInvitationEmail(invitation, invitationLink) {
            try {
                // For now, we'll simulate email sending
                // In production, this would integrate with a real email service
                console.log('Sending invitation email:', {
                    to: invitation.refereeEmail,
                    subject: `Invitation to join ${invitation.clubName} - RefReady`,
                    invitationLink: invitationLink,
                    clubCode: invitation.clubCode
                });
                
                // Simulate email sending delay
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                return { success: true };
            } catch (error) {
                console.error('Send email error:', error);
                throw error;
            }
        }

        // Show invitation success modal
        function showInvitationSuccess(result) {
            const modal = document.getElementById('invitation-success-modal');
            const successMessage = document.getElementById('success-message');
            const invitationDetails = document.getElementById('invitation-details');
            const clubCodeSpan = document.getElementById('generated-club-code');
            const invitationLinkInput = document.getElementById('invitation-link');
            const qrCodeContainer = document.getElementById('qr-code-container');
            
            // Set success message
            successMessage.textContent = `Invitation sent to ${result.invitation.refereeName} (${result.invitation.refereeEmail})`;
            
            // Show invitation details
            invitationDetails.style.display = 'block';
            clubCodeSpan.textContent = result.invitation.clubCode;
            invitationLinkInput.value = result.invitationLink;
            
            // Show QR code if method includes QR
            if (result.invitation.method === 'email' || result.invitation.method === 'qr') {
                qrCodeContainer.style.display = 'block';
                generateQRCode(result.qrCodeData);
            }
            
            // Show modal
            modal.style.display = 'block';
        }

        // Generate QR code
        function generateQRCode(data) {
            const qrDisplay = document.getElementById('qr-code-display');
            qrDisplay.innerHTML = `
                <div style="text-align: center; color: #666;">
                    <div style="font-size: 2em; margin-bottom: 10px;">üì±</div>
                    <p>QR Code Generation</p>
                    <p style="font-size: 12px; margin-top: 10px;">Link: ${data}</p>
                    <p style="font-size: 12px; color: #999;">QR code library integration needed</p>
                </div>
            `;
            
            // TODO: Integrate with QR code library like qrcode.js
            // QRCode.toCanvas(qrDisplay, data, function (error) {
            //     if (error) console.error(error);
            // });
        }

        // Copy to clipboard function
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.tagName === 'INPUT' ? element.value : element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                dashboardManager.showNotification('Copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                dashboardManager.showNotification('Failed to copy to clipboard', 'error');
            });
        }

        // Download invitation details
        function downloadInvitation() {
            const clubCode = document.getElementById('generated-club-code').textContent;
            const invitationLink = document.getElementById('invitation-link').value;
            
            const content = `RefReady Club Invitation Details
            
Club Code: ${clubCode}
Invitation Link: ${invitationLink}

Instructions for Referee:
1. Download the RefReady mobile app
2. Either scan the QR code or use the invitation link
3. Or manually enter the club code: ${clubCode}

Generated on: ${new Date().toLocaleDateString()}`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `RefReady_Invitation_${clubCode}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Make functions globally available
        window.copyToClipboard = copyToClipboard;
        window.downloadInvitation = downloadInvitation;
        
        document.getElementById('invite-mentor-form').addEventListener('submit', (e) => {
            e.preventDefault();
            dashboardManager.showNotification('Invite mentor feature coming soon!', 'info');
        });
    </script>
</body>
</html> 